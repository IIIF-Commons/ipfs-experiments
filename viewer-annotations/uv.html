<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Universal Viewer</title>
    <link rel="icon" href="favicon.ico">
    <link rel="stylesheet" type="text/css" href="vendor/uv/helpers/uv.css">
    <script type="text/javascript" src="vendor/uv/lib/offline.js"></script>
    <script type="text/javascript" src="vendor/uv/uv.js"></script>
    <script type="text/javascript" src="vendor/uv/helpers/helpers.js"></script>
    <script src="https://unpkg.com/ipfs-iiif-db/dist/index.js"></script>
    <style>
        body {
            margin: 0px;
            padding: 20px;
        }

        #uv {
            width: 924px;
            height: 668px;
        }

        #options {
            padding: 20px 0 0 0;
        }
    </style>
</head>
<body>

    <div id="uv" class="uv"></div>

    <div id="options" style="display: none">
        <input id="manifest" placeholder="iiif manifest" type="text" value="" />
        <a id="setManifestButton" class="button" href="#">Set</a>
        <button id="connect">Connect to IPFS</button>
    </div>

    <script type="text/javascript">

        var uv, manifest, urlDataProvider;

        window.addEventListener('uvLoaded', function(e) { 

            urlDataProvider = new UV.URLDataProvider();
            uv = createUV('#uv', {}, urlDataProvider);

            $('#options').show();

            $('#setManifestButton').on('click', function() {
                
                manifest = $('#manifest').val();

                uv.set({
                    root: 'vendor/uv',
                    iiifResourceUri: manifest,
                    collectionIndex: 0,
                    manifestIndex: 0,
                    sequenceIndex: 0,
                    canvasIndex: 0,
                    locales: [
                        {
                            name: "en-GB"
                        }
                    ]
                });
            });

            function connect(cb) {

                // ipfs-iiif-db

                var id = "ipfs-iiif-db-example";

                var db = IpfsIiifDb();

                db.start(function() {

                    var changes = db.get(id, true, (annotations) => {
                        setAnnotations(annotations);
                    });

                    changes.on('change', (annotations) => {
                        setAnnotations(annotations);
                    });

                    cb();
                });
            }

            function setAnnotations(annotations) {
                uv.set({
                    annotations: JSON.parse(annotations)
                });
            }

            var $connect = $('#connect');

            $connect.on('click', function() {
                if (!manifest) {
                    alert('please select a manifest to annotate');
                } else {
                    connect(function() {
                        $connect.prop('disabled', true);
                    });
                }
            });

        }, false);

    </script>

</body>
</html>